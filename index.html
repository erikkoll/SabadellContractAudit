<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria Contractes Sabadell</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a5f7a, #2d8a6e);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .data-source {
            background: #e8f4f8;
            border-left: 4px solid #1a5f7a;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .data-source a {
            color: #1a5f7a;
            text-decoration: none;
            font-weight: 500;
        }

        .data-source a:hover {
            text-decoration: underline;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .upload-section h2 {
            margin-bottom: 20px;
            color: #1a5f7a;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #1a5f7a;
            background: #f0f7fa;
        }

        .upload-area.dragover {
            border-color: #2d8a6e;
            background: #e8f5e9;
        }

        #file-input {
            display: none;
        }

        .btn {
            background: #1a5f7a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #134a5f;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #1a5f7a;
        }

        .alerts-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .alerts-section h2 {
            color: #c0392b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert {
            background: #fdf2f2;
            border-left: 4px solid #c0392b;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .alert.warning {
            background: #fef9e7;
            border-left-color: #f39c12;
        }

        .alert.info {
            background: #e8f4f8;
            border-left-color: #3498db;
        }

        .alert h4 {
            margin-bottom: 5px;
        }

        .alert p {
            color: #666;
            font-size: 0.9em;
        }

        /* Grouped alerts by vendor */
        .vendor-alert-group {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .vendor-alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .vendor-alert-header:hover {
            background: #e9ecef;
        }

        .vendor-alert-header.has-critical {
            background: #fdf2f2;
            border-left: 4px solid #c0392b;
        }

        .vendor-alert-header.has-warning {
            background: #fef9e7;
            border-left: 4px solid #f39c12;
        }

        .vendor-alert-header.has-info {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
        }

        .vendor-info {
            flex: 1;
        }

        .vendor-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .vendor-info .nif {
            font-size: 0.85em;
            color: #666;
        }

        .vendor-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge.alert-count {
            background: #c0392b;
            color: white;
        }

        .badge.warning-count {
            background: #f39c12;
            color: white;
        }

        .badge.info-count {
            background: #3498db;
            color: white;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #666;
            transition: transform 0.3s;
        }

        .vendor-alert-group.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .vendor-alert-details {
            display: none;
            padding: 0;
        }

        .vendor-alert-group.expanded .vendor-alert-details {
            display: block;
        }

        .vendor-alert-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .vendor-alert-item:last-child {
            border-bottom: none;
        }

        .vendor-alert-item.alert-type {
            background: #fdf2f2;
            border-left: 3px solid #c0392b;
        }

        .vendor-alert-item.warning-type {
            background: #fef9e7;
            border-left: 3px solid #f39c12;
        }

        .vendor-alert-item.info-type {
            background: #e8f4f8;
            border-left: 3px solid #3498db;
        }

        .vendor-alert-item strong {
            display: block;
            margin-bottom: 3px;
        }

        .vendor-alert-item p {
            margin: 0;
            color: #555;
        }

        /* Global alerts (not vendor-specific) */
        .global-alerts {
            margin-bottom: 20px;
        }

        .global-alerts h3 {
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .vendor-alerts-section h3 {
            margin: 20px 0 10px 0;
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .alerts-summary {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .alerts-summary .summary-item {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .alerts-summary .summary-item strong {
            color: #1a5f7a;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filters input, .filters select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #1a5f7a;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #1a5f7a;
            color: white;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #134a5f;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f7fa;
        }

        .amount {
            font-weight: bold;
            color: #1a5f7a;
        }

        .company-analysis {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .company-analysis h2 {
            margin-bottom: 20px;
            color: #1a5f7a;
        }

        .company-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .company-row:last-child {
            border-bottom: none;
        }

        .company-name {
            font-weight: 500;
        }

        .company-stats {
            display: flex;
            gap: 20px;
            color: #666;
        }

        .highlight {
            background: #fff3cd;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .threshold-highlight {
            background: #ffeaa7;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        footer a {
            color: #1a5f7a;
        }

        .instructions {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .instructions h2 {
            color: #1a5f7a;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .instructions code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .debug-panel {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .debug-panel h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }

        .debug-panel .mapping {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .debug-panel .field-name {
            color: #81c784;
            min-width: 100px;
        }

        .debug-panel .column-name {
            color: #fff59d;
        }

        .debug-panel .not-found {
            color: #ef5350;
        }

        .debug-panel details {
            margin-top: 15px;
        }

        .debug-panel summary {
            cursor: pointer;
            color: #4fc3f7;
        }

        .debug-panel .all-headers {
            margin-top: 10px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Auditoria de Contractes Publics - Sabadell</h1>
            <p>Eina per analitzar els contractes publics de l'Ajuntament de Sabadell i detectar possibles irregularitats</p>
        </header>

        <div class="data-source">
            <strong>Font de dades:</strong> Les dades provenen del
            <a href="https://dadesobertes.seu-e.cat/dataset/css-rc-contractes-pscp" target="_blank">Portal de Dades Obertes del Consorci AOC</a>
            i del <a href="https://contractacio.ajsabadell.cat/" target="_blank">Portal de Licitacio de l'Ajuntament de Sabadell</a>.
        </div>

        <div class="instructions">
            <h2>Com utilitzar aquesta eina</h2>
            <ol>
                <li><strong>Descarrega les dades:</strong> Ves a <a href="https://dadesobertes.seu-e.cat/csv/css-rc-contractes-pscp-socrata.csv" target="_blank">aquest enllac</a> per descarregar el fitxer CSV amb tots els contractes (pot trigar una mica, es un fitxer gran).</li>
                <li><strong>Carrega el fitxer:</strong> Arrossega el fitxer CSV a l'area de sota o fes clic per seleccionar-lo.</li>
                <li><strong>Filtra per Sabadell:</strong> Un cop carregat, utilitza el filtre "Organisme" per seleccionar "Ajuntament de Sabadell" o altres ens municipals.</li>
                <li><strong>Analitza les alertes:</strong> Revisa la seccio d'alertes per veure possibles irregularitats detectades automaticament.</li>
            </ol>
        </div>

        <div class="upload-section" id="upload-section">
            <h2>Carrega el fitxer de contractes</h2>
            <div class="upload-area" id="upload-area">
                <p>Arrossega el fitxer CSV aqui o fes clic per seleccionar-lo</p>
                <input type="file" id="file-input" accept=".csv">
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">Format acceptat: CSV</p>
        </div>

        <div id="results" class="hidden">
            <div class="debug-panel" id="debug-panel">
                <h3>Columnes detectades del CSV</h3>
                <div id="column-mappings"></div>
                <details>
                    <summary>Veure totes les columnes del CSV</summary>
                    <div class="all-headers" id="all-headers"></div>
                </details>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Contractes</h3>
                    <div class="value" id="total-contracts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Import Total</h3>
                    <div class="value" id="total-amount">0 EUR</div>
                </div>
                <div class="stat-card">
                    <h3>Empreses Diferents</h3>
                    <div class="value" id="unique-companies">0</div>
                </div>
                <div class="stat-card">
                    <h3>Alertes Detectades</h3>
                    <div class="value" id="alerts-count">0</div>
                </div>
            </div>

            <div class="alerts-section" id="alerts-section">
                <h2>Alertes i Indicadors de Risc</h2>
                <div id="alerts-container">
                    <p class="loading">Analitzant dades...</p>
                </div>
            </div>

            <div class="company-analysis">
                <h2>Empreses amb mes contractes</h2>
                <div id="top-companies"></div>
            </div>

            <div class="filters">
                <input type="text" id="search" placeholder="Cercar per text...">
                <select id="filter-org">
                    <option value="">Tots els organismes</option>
                </select>
                <select id="filter-type">
                    <option value="">Tots els tipus</option>
                </select>
                <select id="filter-year">
                    <option value="">Tots els anys</option>
                </select>
                <button class="btn btn-secondary" onclick="resetFilters()">Netejar filtres</button>
                <button class="btn" onclick="exportFiltered()">Exportar filtrat (CSV)</button>
            </div>

            <div class="table-container">
                <table id="contracts-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('org')">Organisme</th>
                            <th onclick="sortTable('object')">Objecte</th>
                            <th onclick="sortTable('company')">Adjudicatari</th>
                            <th onclick="sortTable('amount')">Import</th>
                            <th onclick="sortTable('date')">Data</th>
                            <th onclick="sortTable('type')">Tipus</th>
                        </tr>
                    </thead>
                    <tbody id="contracts-body">
                    </tbody>
                </table>
            </div>

            <div id="pagination" style="text-align: center; margin: 20px 0;">
                <button class="btn btn-secondary" onclick="prevPage()">Anterior</button>
                <span id="page-info" style="margin: 0 20px;"></span>
                <button class="btn btn-secondary" onclick="nextPage()">Seguent</button>
            </div>
        </div>

        <footer>
            <p>Eina creada per promoure la transparencia i la participacio ciutadana.</p>
            <p>Dades obertes de <a href="https://dadesobertes.seu-e.cat/" target="_blank">Consorci AOC</a> |
               <a href="https://web.sabadell.cat/transparencia" target="_blank">Portal de Transparencia de Sabadell</a></p>
        </footer>
    </div>

    <script>
        let allContracts = [];
        let filteredContracts = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let csvHeaders = []; // Store headers for debugging

        // Thresholds for contract types (simplified - actual thresholds vary)
        const THRESHOLDS = {
            minor: 15000,      // Contractes menors serveis/subministraments
            minorWorks: 40000, // Contractes menors obres
            negotiated: 60000  // Procediment negociat
        };

        // Column mappings - ordered by priority (most specific first)
        // Based on actual CSV from Consorci AOC: denominacio_adjudicatari is company name,
        // identificacio_adjudicatari is NIF, data_adjudicacio_contracte is date
        const COLUMN_MAPPINGS = {
            org: [
                'nom_organ', 'nom_ens', 'nom ens', 'ens', 'organ_contractacio',
                'organisme', 'entitat', 'administracio'
            ],
            object: [
                'objecte_contracte', 'objecte contracte', 'objecte', 'descripcio_contracte',
                'descripcio', 'titol', 'nom_contracte'
            ],
            company: [
                'denominacio_adjudicatari',  // This is the actual company name in Consorci AOC data
                'rao_social_adjudicatari', 'rao social adjudicatari', 'nom_adjudicatari',
                'nom adjudicatari', 'adjudicatari_rao_social', 'empresa_adjudicataria',
                'nom_empresa', 'rao_social'
            ],
            nif: [
                'identificacio_adjudicatari',  // This is the actual NIF in Consorci AOC data
                'nif_adjudicatari', 'nif adjudicatari', 'cif_adjudicatari',
                'identificador_adjudicatari'
            ],
            amount: [
                'import_adjudicacio_sense_iva', 'import_adjudicacio_amb_iva',
                'import_adjudicacio', 'import adjudicacio', 'import_licitacio',
                'preu_adjudicacio', 'valor_estimat', 'import', 'preu', 'valor'
            ],
            date: [
                'data_adjudicacio_contracte',  // This is the actual date in Consorci AOC data
                'data_adjudicacio', 'data adjudicacio', 'data_formalitzacio',
                'data_formalitzacio_contracte', 'data_publicacio', 'data_inici', 'data'
            ],
            type: [
                'tipus_contracte', 'tipus contracte', 'tipus'
            ],
            // New fields for advanced detection
            procedure: [
                'procediment_adjudicacio', 'procediment', 'tipus_procediment'
            ],
            cpv: [
                'codi_cpv', 'cpv', 'codi_cpv_principal'
            ],
            budget: [
                'pressupost_licitacio_sense_iva', 'pressupost_licitacio',
                'valor_estimat_contracte', 'valor_estimat'
            ],
            bidsReceived: [
                'ofertes_rebudes', 'nombre_ofertes', 'num_ofertes', 'licitadors'
            ],
            publicationDate: [
                'data_publicacio_anunci', 'data_publicacio', 'data_anunci'
            ],
            offerDeadline: [
                'termini_presentacio_ofertes', 'data_limit_presentacio',
                'data_fi_presentacio', 'termini_ofertes'
            ],
            department: [
                'nom_departament_ens', 'departament', 'unitat_tramitadora',
                'area', 'servei'
            ],
            expedient: [
                'codi_expedient', 'numero_expedient', 'expedient', 'referencia'
            ]
        };

        // Upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);
            csvHeaders = headers.map(h => h.trim().toLowerCase());

            // Log headers to console for debugging
            console.log('CSV Headers found:', csvHeaders);

            allContracts = [];

            // Create header index map for faster lookup
            const headerIndex = {};
            csvHeaders.forEach((header, index) => {
                headerIndex[header] = index;
            });

            // Find the best matching column for each field type
            const columnMap = {};
            for (const [fieldType, possibleNames] of Object.entries(COLUMN_MAPPINGS)) {
                columnMap[fieldType] = findBestColumn(csvHeaders, possibleNames);
                console.log(`Mapping ${fieldType} -> ${columnMap[fieldType]}`);
            }

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = parseCSVLine(lines[i]);

                // Create contract object with normalized fields
                const contract = {
                    raw: {},
                    normalized: {}
                };

                // Store raw values
                csvHeaders.forEach((header, index) => {
                    contract.raw[header] = values[index] || '';
                });

                // Map to normalized fields using our column mapping
                contract.normalized = {
                    org: columnMap.org ? (contract.raw[columnMap.org] || '') : '',
                    object: columnMap.object ? (contract.raw[columnMap.object] || '') : '',
                    company: columnMap.company ? (contract.raw[columnMap.company] || '') : '',
                    nif: columnMap.nif ? (contract.raw[columnMap.nif] || '') : '',
                    amount: parseAmount(columnMap.amount ? (contract.raw[columnMap.amount] || '') : ''),
                    date: columnMap.date ? (contract.raw[columnMap.date] || '') : '',
                    type: columnMap.type ? (contract.raw[columnMap.type] || '') : '',
                    // New fields for advanced detection
                    procedure: columnMap.procedure ? (contract.raw[columnMap.procedure] || '') : '',
                    cpv: columnMap.cpv ? (contract.raw[columnMap.cpv] || '') : '',
                    budget: parseAmount(columnMap.budget ? (contract.raw[columnMap.budget] || '') : ''),
                    bidsReceived: parseInt(columnMap.bidsReceived ? (contract.raw[columnMap.bidsReceived] || '') : '') || 0,
                    publicationDate: columnMap.publicationDate ? (contract.raw[columnMap.publicationDate] || '') : '',
                    offerDeadline: columnMap.offerDeadline ? (contract.raw[columnMap.offerDeadline] || '') : '',
                    department: columnMap.department ? (contract.raw[columnMap.department] || '') : '',
                    expedient: columnMap.expedient ? (contract.raw[columnMap.expedient] || '') : ''
                };

                allContracts.push(contract);
            }

            console.log('Total contracts loaded:', allContracts.length);
            console.log('Sample contract:', allContracts[0]);

            // Update debug panel
            updateDebugPanel(columnMap);

            // Filter for Sabadell if possible
            const sabadellContracts = allContracts.filter(c =>
                c.normalized.org.toLowerCase().includes('sabadell')
            );

            console.log('Sabadell contracts found:', sabadellContracts.length);

            if (sabadellContracts.length > 0) {
                filteredContracts = sabadellContracts;
            } else {
                filteredContracts = allContracts;
            }

            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            populateFilters();
            analyzeData();
            renderTable();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if ((char === ',' || char === ';') && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());

            return result;
        }

        function findBestColumn(headers, possibleNames) {
            // First pass: exact match
            for (const name of possibleNames) {
                const exactMatch = headers.find(h => h === name);
                if (exactMatch) return exactMatch;
            }

            // Second pass: contains match (but be careful with order)
            for (const name of possibleNames) {
                const containsMatch = headers.find(h => h.includes(name) && !isExcludedMatch(h, name));
                if (containsMatch) return containsMatch;
            }

            return null;
        }

        // Avoid matching NIF fields when looking for company names, etc.
        function isExcludedMatch(header, searchTerm) {
            // If searching for 'adjudicatari' but header is 'nif_adjudicatari', skip it
            if (searchTerm === 'adjudicatari' && header.includes('nif')) return true;
            if (searchTerm === 'adjudicatari' && header.includes('cif')) return true;
            return false;
        }

        // Check if a string looks like a valid company name
        function isInvalidCompanyName(name) {
            if (!name) return true;
            const upper = name.toUpperCase().trim();
            // Invalid patterns: looks like NIF, too short, only numbers, only punctuation
            if (upper === 'NIF' || upper === 'CIF') return true;
            if (/^[A-Z]?\d{7,8}[A-Z]?$/.test(upper)) return true; // NIF pattern
            if (/^\d+$/.test(upper)) return true; // Only numbers
            if (/^[^a-zA-Z]+$/.test(upper)) return true; // No letters
            if (upper.includes('NIF||')) return true; // Corrupted data pattern
            if (upper.split('||').length > 2) return true; // Multiple delimiters
            return false;
        }

        // String similarity function (similar to Python's difflib.SequenceMatcher)
        // Returns a ratio between 0 and 1 (1 = identical)
        function stringSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;

            // Normalize strings: lowercase, remove extra spaces and punctuation
            const normalize = (s) => s.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            const s1 = normalize(str1);
            const s2 = normalize(str2);

            if (s1 === s2) return 1;
            if (s1.length === 0 || s2.length === 0) return 0;

            // Use Longest Common Subsequence approach for similarity
            const longer = s1.length > s2.length ? s1 : s2;
            const shorter = s1.length > s2.length ? s2 : s1;

            // Simple approach: count matching words
            const words1 = new Set(s1.split(' ').filter(w => w.length > 2));
            const words2 = new Set(s2.split(' ').filter(w => w.length > 2));

            if (words1.size === 0 || words2.size === 0) return 0;

            let matches = 0;
            words1.forEach(w => {
                if (words2.has(w)) matches++;
            });

            // Jaccard-like similarity
            const union = new Set([...words1, ...words2]).size;
            return matches / union;
        }

        // Get CPV root (first 3 digits = division level)
        function getCpvRoot(cpv) {
            if (!cpv) return null;
            const match = cpv.toString().match(/^(\d{3})/);
            return match ? match[1] : null;
        }

        function updateDebugPanel(columnMap) {
            const fieldLabels = {
                org: 'Organisme',
                object: 'Objecte',
                company: 'Adjudicatari',
                nif: 'NIF',
                amount: 'Import',
                date: 'Data',
                type: 'Tipus',
                procedure: 'Procediment',
                cpv: 'CPV',
                budget: 'Pressupost',
                bidsReceived: 'Ofertes rebudes',
                publicationDate: 'Data publicacio',
                offerDeadline: 'Termini ofertes',
                department: 'Departament',
                expedient: 'Expedient'
            };

            const mappingsHtml = Object.entries(columnMap).map(([field, column]) => `
                <div class="mapping">
                    <span class="field-name">${fieldLabels[field]}:</span>
                    ${column
                        ? `<span class="column-name">"${column}"</span>`
                        : `<span class="not-found">NO TROBAT</span>`
                    }
                </div>
            `).join('');

            document.getElementById('column-mappings').innerHTML = mappingsHtml;
            document.getElementById('all-headers').innerHTML = csvHeaders.map(h => `"${h}"`).join(', ');
        }

        function parseAmount(value) {
            if (!value) return 0;
            // Remove currency symbols, spaces, and handle European number format
            const cleaned = value.toString()
                .replace(/[^0-9,.\-]/g, '')
                .replace(/\.(?=.*,)/g, '')  // Remove thousand separators
                .replace(',', '.');          // Convert decimal comma to point
            return parseFloat(cleaned) || 0;
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('ca-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Handle various date formats: YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY
            let match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return new Date(match[1], match[2] - 1, match[3]);
            }
            match = dateStr.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
            if (match) {
                return new Date(match[3], match[2] - 1, match[1]);
            }
            // Try native parsing as fallback
            const parsed = new Date(dateStr);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function populateFilters() {
            const orgs = [...new Set(allContracts.map(c => c.normalized.org).filter(Boolean))].sort();
            const types = [...new Set(allContracts.map(c => c.normalized.type).filter(Boolean))].sort();
            const years = [...new Set(allContracts.map(c => {
                const date = c.normalized.date;
                const match = date.match(/\d{4}/);
                return match ? match[0] : null;
            }).filter(Boolean))].sort().reverse();

            const orgSelect = document.getElementById('filter-org');
            orgs.forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org.length > 50 ? org.substring(0, 50) + '...' : org;
                orgSelect.appendChild(option);
            });

            const typeSelect = document.getElementById('filter-type');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            const yearSelect = document.getElementById('filter-year');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            // Add filter event listeners
            document.getElementById('search').addEventListener('input', applyFilters);
            document.getElementById('filter-org').addEventListener('change', applyFilters);
            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('filter-year').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const org = document.getElementById('filter-org').value;
            const type = document.getElementById('filter-type').value;
            const year = document.getElementById('filter-year').value;

            filteredContracts = allContracts.filter(c => {
                const matchSearch = !search ||
                    c.normalized.object.toLowerCase().includes(search) ||
                    c.normalized.company.toLowerCase().includes(search) ||
                    c.normalized.org.toLowerCase().includes(search);

                const matchOrg = !org || c.normalized.org === org;
                const matchType = !type || c.normalized.type === type;
                const matchYear = !year || c.normalized.date.includes(year);

                return matchSearch && matchOrg && matchType && matchYear;
            });

            currentPage = 1;
            analyzeData();
            renderTable();
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-org').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-year').value = '';
            filteredContracts = allContracts;
            currentPage = 1;
            analyzeData();
            renderTable();
        }

        function analyzeData() {
            // Basic stats
            const totalContracts = filteredContracts.length;
            const totalAmount = filteredContracts.reduce((sum, c) => sum + c.normalized.amount, 0);
            const uniqueCompanies = new Set(filteredContracts.map(c => c.normalized.company).filter(Boolean)).size;

            document.getElementById('total-contracts').textContent = totalContracts.toLocaleString('ca-ES');
            document.getElementById('total-amount').textContent = formatAmount(totalAmount);
            document.getElementById('unique-companies').textContent = uniqueCompanies.toLocaleString('ca-ES');

            // Analyze for potential issues
            const alerts = [];

            // 1. Companies with many contracts
            const companyContracts = {};
            const companyAmounts = {};
            filteredContracts.forEach(c => {
                const company = c.normalized.company;
                // Skip invalid company names (too short, looks like a NIF, or contains only special chars)
                if (company && company.length > 5 && !isInvalidCompanyName(company)) {
                    companyContracts[company] = (companyContracts[company] || 0) + 1;
                    companyAmounts[company] = (companyAmounts[company] || 0) + c.normalized.amount;
                }
            });

            const topCompanies = Object.entries(companyContracts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Build NIF lookup for company names
            const companyToNif = {};
            filteredContracts.forEach(c => {
                if (c.normalized.company && c.normalized.nif) {
                    companyToNif[c.normalized.company] = c.normalized.nif;
                }
            });

            // Alert for companies with disproportionate contracts
            topCompanies.forEach(([company, count]) => {
                const percentage = (count / totalContracts * 100).toFixed(1);
                if (percentage > 5 && count > 10) {
                    alerts.push({
                        type: 'warning',
                        title: `Concentracio de contractes`,
                        description: `Aquesta empresa te ${count} contractes (${percentage}% del total), amb un import total de ${formatAmount(companyAmounts[company])}.`,
                        vendor: { nif: companyToNif[company] || '', company: company }
                    });
                }
            });

            // ============================================================
            // INTELLIGENT CONTRACT SPLITTING DETECTION
            // Three linkage checks based on anti-corruption best practices
            // ============================================================

            // Helper: extract fiscal year from date
            function getFiscalYear(dateStr) {
                if (!dateStr) return null;
                const match = dateStr.match(/\d{4}/);
                return match ? match[0] : null;
            }

            // ----------------------------------------------------------
            // 1A. CPV ROOT LOGIC
            // Group by: NIF + CPV root (first 3 digits) + Fiscal Year
            // Flag if combined value exceeds threshold
            // ----------------------------------------------------------
            const cpvGroups = {};
            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const cpvRoot = getCpvRoot(c.normalized.cpv);
                const year = getFiscalYear(c.normalized.date);

                if (nif && cpvRoot && year && c.normalized.amount > 0 && c.normalized.amount < THRESHOLDS.minorWorks) {
                    const key = `${nif}|||${cpvRoot}|||${year}`;
                    if (!cpvGroups[key]) {
                        cpvGroups[key] = {
                            nif: nif,
                            company: c.normalized.company,
                            cpvRoot: cpvRoot,
                            year: year,
                            contracts: [],
                            totalAmount: 0
                        };
                    }
                    cpvGroups[key].contracts.push(c);
                    cpvGroups[key].totalAmount += c.normalized.amount;
                }
            });

            Object.values(cpvGroups).forEach(group => {
                if (group.contracts.length < 2) return;

                const allUnderMinor = group.contracts.every(c => c.normalized.amount < THRESHOLDS.minor);
                const allUnderWorks = group.contracts.every(c => c.normalized.amount < THRESHOLDS.minorWorks);

                if (allUnderMinor && group.totalAmount >= THRESHOLDS.minor) {
                    alerts.push({
                        type: 'alert',
                        title: `Fraccionament CPV`,
                        description: `${group.contracts.length} contractes menors en el sector CPV ${group.cpvRoot}xxx durant ${group.year}. Total: ${formatAmount(group.totalAmount)} (supera 15.000€).`,
                        vendor: { nif: group.nif, company: group.company || '' }
                    });
                } else if (allUnderWorks && group.totalAmount >= THRESHOLDS.minorWorks) {
                    alerts.push({
                        type: 'alert',
                        title: `Fraccionament CPV (obres)`,
                        description: `${group.contracts.length} contractes menors en el sector CPV ${group.cpvRoot}xxx durant ${group.year}. Total: ${formatAmount(group.totalAmount)} (supera 40.000€).`,
                        vendor: { nif: group.nif, company: group.company || '' }
                    });
                }
            });

            // ----------------------------------------------------------
            // 1B. SEMANTIC SIMILARITY CHECK
            // Compare objecte_contracte fields for >80% similarity
            // Flag if similar descriptions and combined exceeds threshold
            // ----------------------------------------------------------
            const vendorYearContracts = {};
            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const year = getFiscalYear(c.normalized.date);
                if (nif && year && c.normalized.object && c.normalized.amount > 0) {
                    const key = `${nif}|||${year}`;
                    if (!vendorYearContracts[key]) {
                        vendorYearContracts[key] = {
                            nif: nif,
                            company: c.normalized.company,
                            year: year,
                            contracts: []
                        };
                    }
                    vendorYearContracts[key].contracts.push(c);
                }
            });

            // Check for semantic similarity within each vendor-year group
            const alreadyFlaggedSemantic = new Set();
            Object.values(vendorYearContracts).forEach(group => {
                if (group.contracts.length < 2) return;

                // Compare pairs of contracts for similarity
                for (let i = 0; i < group.contracts.length; i++) {
                    for (let j = i + 1; j < group.contracts.length; j++) {
                        const c1 = group.contracts[i];
                        const c2 = group.contracts[j];

                        const similarity = stringSimilarity(c1.normalized.object, c2.normalized.object);

                        if (similarity >= 0.8) {
                            const combinedAmount = c1.normalized.amount + c2.normalized.amount;
                            const bothUnderMinor = c1.normalized.amount < THRESHOLDS.minor && c2.normalized.amount < THRESHOLDS.minor;
                            const bothUnderWorks = c1.normalized.amount < THRESHOLDS.minorWorks && c2.normalized.amount < THRESHOLDS.minorWorks;

                            const alertKey = `${group.nif}|||${group.year}|||semantic`;
                            if (!alreadyFlaggedSemantic.has(alertKey)) {
                                if (bothUnderMinor && combinedAmount >= THRESHOLDS.minor) {
                                    alreadyFlaggedSemantic.add(alertKey);
                                    alerts.push({
                                        type: 'alert',
                                        title: `Fraccionament semantic`,
                                        description: `Contractes amb descripcions similars (${(similarity * 100).toFixed(0)}% similitud) durant ${group.year}. Exemple: "${c1.normalized.object.substring(0, 50)}..." Total combinat: ${formatAmount(combinedAmount)} (supera 15.000€).`,
                                        vendor: { nif: group.nif, company: group.company || '' }
                                    });
                                } else if (bothUnderWorks && combinedAmount >= THRESHOLDS.minorWorks) {
                                    alreadyFlaggedSemantic.add(alertKey);
                                    alerts.push({
                                        type: 'alert',
                                        title: `Fraccionament semantic (obres)`,
                                        description: `Contractes amb descripcions similars (${(similarity * 100).toFixed(0)}% similitud) durant ${group.year}. Total combinat: ${formatAmount(combinedAmount)} (supera 40.000€).`,
                                        vendor: { nif: group.nif, company: group.company || '' }
                                    });
                                }
                            }
                        }
                    }
                }
            });

            // ----------------------------------------------------------
            // 1C. TEMPORAL BURST CHECK
            // Flag: >2 contracts to same vendor within 30-day rolling window
            // Mark as "High Velocity / Urgency Risk"
            // ----------------------------------------------------------
            const vendorContracts = {};
            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                if (nif && c.normalized.date) {
                    if (!vendorContracts[nif]) {
                        vendorContracts[nif] = {
                            nif: nif,
                            company: c.normalized.company,
                            contracts: []
                        };
                    }
                    vendorContracts[nif].contracts.push({
                        date: parseDate(c.normalized.date),
                        dateStr: c.normalized.date,
                        amount: c.normalized.amount,
                        object: c.normalized.object
                    });
                }
            });

            const alreadyFlaggedBurst = new Set();
            Object.values(vendorContracts).forEach(group => {
                if (group.contracts.length < 3) return;

                // Sort by date
                const sorted = group.contracts
                    .filter(c => c.date)
                    .sort((a, b) => a.date - b.date);

                // Sliding window check
                for (let i = 0; i < sorted.length - 2; i++) {
                    const windowStart = sorted[i].date;
                    let windowContracts = [sorted[i]];

                    for (let j = i + 1; j < sorted.length; j++) {
                        const daysDiff = (sorted[j].date - windowStart) / (1000 * 60 * 60 * 24);
                        if (daysDiff <= 30) {
                            windowContracts.push(sorted[j]);
                        } else {
                            break;
                        }
                    }

                    // Flag if >2 contracts in 30-day window
                    if (windowContracts.length > 2) {
                        const alertKey = `${group.nif}|||${windowContracts[0].dateStr}`;
                        if (!alreadyFlaggedBurst.has(alertKey)) {
                            alreadyFlaggedBurst.add(alertKey);
                            const totalAmount = windowContracts.reduce((sum, c) => sum + c.amount, 0);
                            alerts.push({
                                type: 'warning',
                                title: `Alta velocitat`,
                                description: `${windowContracts.length} contractes en 30 dies (${windowContracts[0].dateStr} - ${windowContracts[windowContracts.length - 1].dateStr}). Total: ${formatAmount(totalAmount)}. Risc d'urgencia o fraccionament.`,
                                vendor: { nif: group.nif, company: group.company || '' }
                            });
                        }
                        // Skip ahead to avoid duplicate alerts
                        i += windowContracts.length - 2;
                    }
                }
            });

            // ----------------------------------------------------------
            // 2. STRATEGIC THRESHOLD (Llindar Estrategic)
            // Flag contracts in suspicious ranges: €14,900-€14,999 or €39,900-€39,999
            // ----------------------------------------------------------
            const strategicThreshold = filteredContracts.filter(c => {
                const amount = c.normalized.amount;
                return (amount >= 14900 && amount <= 14999) ||
                       (amount >= 39900 && amount <= 39999);
            });

            if (strategicThreshold.length > 0) {
                alerts.push({
                    type: 'alert',
                    title: `${strategicThreshold.length} contractes amb import "estrategic"`,
                    description: `Contractes amb imports entre €14.900-€14.999 o €39.900-€39.999, just per sota dels llindars legals. Risc ALT: podria indicar manipulacio del pressupost per evitar supervisio.`
                });
            }

            // ----------------------------------------------------------
            // 3. SINGLE BIDDER (Absencia de Competencia)
            // Open procedures with only 1 bid received
            // ----------------------------------------------------------
            const singleBidder = filteredContracts.filter(c => {
                const isOpen = c.normalized.procedure.toLowerCase().includes('obert');
                return isOpen && c.normalized.bidsReceived === 1;
            });

            if (singleBidder.length > 5) {
                alerts.push({
                    type: 'warning',
                    title: `${singleBidder.length} procediments oberts amb un sol licitador`,
                    description: `Procediments oberts on nomes es va presentar una oferta. Pot indicar que el plec estava fet a mida o que altres empreses van ser descoratjades a participar.`
                });
            }

            // ----------------------------------------------------------
            // 4. ZERO DISCOUNT (Possible Col·lusio)
            // Award amount equals budget exactly (in open procedures)
            // ----------------------------------------------------------
            const zeroDiscount = filteredContracts.filter(c => {
                const isOpen = c.normalized.procedure.toLowerCase().includes('obert');
                const hasBudget = c.normalized.budget > 0;
                const hasAmount = c.normalized.amount > 0;
                if (!isOpen || !hasBudget || !hasAmount) return false;

                const difference = Math.abs(c.normalized.budget - c.normalized.amount);
                const percentDiff = (difference / c.normalized.budget) * 100;
                return percentDiff < 0.1; // Less than 0.1% difference
            });

            if (zeroDiscount.length > 3) {
                alerts.push({
                    type: 'warning',
                    title: `${zeroDiscount.length} adjudicacions sense descompte`,
                    description: `Procediments oberts on l'import adjudicat es exactament igual al pressupost de licitacio (0% descompte). En un mercat competitiu, normalment hi ha alguna rebaixa.`
                });
            }

            // ----------------------------------------------------------
            // 5. SPEED BIDDING (Terminis Sospitosament Curts)
            // Short time between publication and deadline
            // ----------------------------------------------------------
            const speedBidding = filteredContracts.filter(c => {
                if (!c.normalized.publicationDate || !c.normalized.offerDeadline) return false;

                const pubDate = parseDate(c.normalized.publicationDate);
                const deadline = parseDate(c.normalized.offerDeadline);
                if (!pubDate || !deadline) return false;

                const daysDiff = (deadline - pubDate) / (1000 * 60 * 60 * 24);
                const estimatedValue = c.normalized.budget || c.normalized.amount;

                // High value (>200k) with <15 days, or lower value with <5 days
                if (estimatedValue > 200000 && daysDiff < 15 && daysDiff > 0) return true;
                if (estimatedValue <= 200000 && daysDiff < 5 && daysDiff > 0) return true;
                return false;
            });

            if (speedBidding.length > 0) {
                alerts.push({
                    type: 'alert',
                    title: `${speedBidding.length} licitacions amb termini molt curt`,
                    description: `Procediments amb un termini de presentacio d'ofertes sospitosament curt. Nomes algú amb informacio privilegiada podria preparar una oferta valida.`
                });
            }

            // ----------------------------------------------------------
            // 6. DEPARTMENT CONCENTRATION (Concentracio per Departament)
            // Single vendor receives >50% of a department's budget in one year
            // ----------------------------------------------------------
            const deptBudgets = {};
            const deptVendorAmounts = {};

            filteredContracts.forEach(c => {
                const dept = c.normalized.department || c.normalized.org;
                const nif = c.normalized.nif;
                const year = getFiscalYear(c.normalized.date) || 'unknown';

                if (dept && nif && c.normalized.amount > 0) {
                    const deptKey = `${dept}|||${year}`;
                    const vendorKey = `${dept}|||${nif}|||${year}`;

                    deptBudgets[deptKey] = (deptBudgets[deptKey] || 0) + c.normalized.amount;

                    if (!deptVendorAmounts[vendorKey]) {
                        deptVendorAmounts[vendorKey] = {
                            dept: dept,
                            nif: nif,
                            company: c.normalized.company,
                            year: year,
                            amount: 0
                        };
                    }
                    deptVendorAmounts[vendorKey].amount += c.normalized.amount;
                }
            });

            Object.values(deptVendorAmounts).forEach(v => {
                const deptKey = `${v.dept}|||${v.year}`;
                const deptTotal = deptBudgets[deptKey] || 0;

                if (deptTotal > 50000 && v.amount > deptTotal * 0.5) {
                    const percentage = ((v.amount / deptTotal) * 100).toFixed(1);
                    alerts.push({
                        type: 'warning',
                        title: `Concentracio departamental`,
                        description: `Rep el ${percentage}% del pressupost de "${v.dept.substring(0, 40)}..." durant ${v.year} (${formatAmount(v.amount)} de ${formatAmount(deptTotal)}).`,
                        vendor: { nif: v.nif, company: v.company || '' }
                    });
                }
            });

            // ----------------------------------------------------------
            // 7. MISSING IDENTIFICATION (Original indicator - kept)
            // ----------------------------------------------------------
            const noNIF = filteredContracts.filter(c => !c.normalized.nif && c.normalized.amount > 5000);
            if (noNIF.length > 10) {
                alerts.push({
                    type: 'info',
                    title: `${noNIF.length} contractes sense NIF/CIF`,
                    description: `Alguns contractes de mes de 5.000€ no tenen identificacio fiscal de l'empresa adjudicataria.`
                });
            }

            // ----------------------------------------------------------
            // 8. BENFORD'S LAW TEST (Second Digit Analysis)
            // Natural numbers follow a specific distribution for second digits
            // Fraudulent amounts often violate this pattern
            // ----------------------------------------------------------
            const benfordExpected = [0.12, 0.114, 0.109, 0.104, 0.100, 0.097, 0.093, 0.090, 0.088, 0.085];
            const vendorSecondDigits = {};

            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const amount = c.normalized.amount;
                if (nif && amount > 100 && amount < THRESHOLDS.minor) {
                    // Extract second digit from amount
                    const amountStr = Math.floor(amount).toString();
                    if (amountStr.length >= 2) {
                        const secondDigit = parseInt(amountStr[1]);
                        if (!vendorSecondDigits[nif]) {
                            vendorSecondDigits[nif] = {
                                nif: nif,
                                company: c.normalized.company,
                                digits: Array(10).fill(0),
                                total: 0
                            };
                        }
                        vendorSecondDigits[nif].digits[secondDigit]++;
                        vendorSecondDigits[nif].total++;
                    }
                }
            });

            Object.values(vendorSecondDigits).forEach(v => {
                if (v.total < 10) return; // Need minimum sample size

                // Calculate chi-squared statistic for Benford deviation
                let chiSquared = 0;
                const observed = v.digits.map(d => d / v.total);

                for (let i = 0; i < 10; i++) {
                    const diff = observed[i] - benfordExpected[i];
                    chiSquared += (diff * diff) / benfordExpected[i];
                }

                // Check for uniform distribution (too even = suspicious)
                const isUniform = observed.every(o => o >= 0.08 && o <= 0.12);

                // Check for digit spike (any digit > 20%)
                const maxDigit = Math.max(...observed);
                const maxDigitIndex = observed.indexOf(maxDigit);

                if (chiSquared > 0.05 && (isUniform || maxDigit > 0.20)) {
                    alerts.push({
                        type: 'warning',
                        title: `Benford anomalia`,
                        description: isUniform
                            ? `Distribucio massa uniforme dels segons digits en ${v.total} contractes. Patró antinatural que suggereix manipulacio.`
                            : `El digit ${maxDigitIndex} apareix el ${(maxDigit * 100).toFixed(0)}% de les vegades en ${v.total} contractes (esperat: ~${(benfordExpected[maxDigitIndex] * 100).toFixed(0)}%). Possible manipulacio d'imports.`,
                        vendor: { nif: v.nif, company: v.company || '' }
                    });
                }
            });

            // ----------------------------------------------------------
            // 9. ROUNDEDNESS RATIO (Last Digit Analysis)
            // Real costs rarely end in round numbers
            // Fraudulent splits often use clean amounts
            // ----------------------------------------------------------
            const vendorRoundness = {};

            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const amount = c.normalized.amount;
                if (nif && amount > 0) {
                    if (!vendorRoundness[nif]) {
                        vendorRoundness[nif] = {
                            nif: nif,
                            company: c.normalized.company,
                            total: 0,
                            roundCount: 0
                        };
                    }
                    vendorRoundness[nif].total++;
                    // Check if divisible by 100 or 50 (round number)
                    if (amount % 100 === 0 || amount % 50 === 0) {
                        vendorRoundness[nif].roundCount++;
                    }
                }
            });

            Object.values(vendorRoundness).forEach(v => {
                if (v.total < 5) return; // Need minimum contracts

                const roundPercentage = (v.roundCount / v.total) * 100;
                if (roundPercentage > 50) {
                    alerts.push({
                        type: 'warning',
                        title: `Imports rodons`,
                        description: `El ${roundPercentage.toFixed(0)}% dels ${v.total} contractes tenen imports rodons (divisibles per 50 o 100€). En costos reals, aixo es estrany.`,
                        vendor: { nif: v.nif, company: v.company || '' }
                    });
                }
            });

            // ----------------------------------------------------------
            // 10. CLUSTER HISTOGRAM (Density Analysis)
            // Normal distribution: lots of small contracts, few large
            // Suspicious: "bulge" near threshold indicates gaming
            // ----------------------------------------------------------
            const minorContracts = filteredContracts.filter(c =>
                c.normalized.amount > 0 && c.normalized.amount < THRESHOLDS.minor
            );

            if (minorContracts.length > 50) {
                // Count contracts in the €12k-15k range vs total
                const nearThreshold = minorContracts.filter(c => c.normalized.amount >= 12000);
                const ratio = nearThreshold.length / minorContracts.length;

                if (ratio > 0.4) {
                    alerts.push({
                        type: 'alert',
                        title: `Concentracio al llindar: ${(ratio * 100).toFixed(0)}% de contractes entre 12-15k€`,
                        description: `El ${(ratio * 100).toFixed(0)}% dels contractes menors estan en el rang €12.000-€15.000 (${nearThreshold.length} de ${minorContracts.length}). Distribucio anormal que suggereix fraccionament sistematic.`
                    });
                }
            }

            // Same for works threshold
            const minorWorksContracts = filteredContracts.filter(c =>
                c.normalized.amount > 0 && c.normalized.amount < THRESHOLDS.minorWorks &&
                c.normalized.type.toLowerCase().includes('obr')
            );

            if (minorWorksContracts.length > 30) {
                const nearWorksThreshold = minorWorksContracts.filter(c => c.normalized.amount >= 32000);
                const worksRatio = nearWorksThreshold.length / minorWorksContracts.length;

                if (worksRatio > 0.4) {
                    alerts.push({
                        type: 'alert',
                        title: `Concentracio obres: ${(worksRatio * 100).toFixed(0)}% de contractes entre 32-40k€`,
                        description: `El ${(worksRatio * 100).toFixed(0)}% dels contractes menors d'obres estan en el rang €32.000-€40.000 (${nearWorksThreshold.length} de ${minorWorksContracts.length}). Distribucio anormal.`
                    });
                }
            }

            // ----------------------------------------------------------
            // 11. DEPARTMENTAL MONOGAMY (Vendor Dependence)
            // Legitimate companies have diverse clients
            // Shell companies depend on single department
            // ----------------------------------------------------------
            const vendorDeptRevenue = {};
            const vendorTotalRevenue = {};

            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const dept = c.normalized.department || c.normalized.org;
                const amount = c.normalized.amount;

                if (nif && dept && amount > 0) {
                    if (!vendorTotalRevenue[nif]) {
                        vendorTotalRevenue[nif] = {
                            nif: nif,
                            company: c.normalized.company,
                            total: 0,
                            contractCount: 0,
                            depts: {}
                        };
                    }
                    vendorTotalRevenue[nif].total += amount;
                    vendorTotalRevenue[nif].contractCount++;
                    vendorTotalRevenue[nif].depts[dept] = (vendorTotalRevenue[nif].depts[dept] || 0) + amount;
                }
            });

            Object.values(vendorTotalRevenue).forEach(v => {
                if (v.contractCount < 4) return; // Need minimum activity

                // Find the department with highest revenue
                const deptAmounts = Object.entries(v.depts);
                if (deptAmounts.length === 0) return;

                deptAmounts.sort((a, b) => b[1] - a[1]);
                const [topDept, topAmount] = deptAmounts[0];
                const dependenceRatio = topAmount / v.total;

                if (dependenceRatio > 0.9 && v.total > 20000) {
                    alerts.push({
                        type: 'warning',
                        title: `Monogamia departamental`,
                        description: `Rep el ${(dependenceRatio * 100).toFixed(0)}% dels seus ingressos (${formatAmount(topAmount)} de ${formatAmount(v.total)}) d'un sol departament. Risc d'empresa pantalla.`,
                        vendor: { nif: v.nif, company: v.company || '' }
                    });
                }
            });

            // Render alerts - grouped by vendor
            const alertsContainer = document.getElementById('alerts-container');
            document.getElementById('alerts-count').textContent = alerts.length;

            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<p class="alert info"><strong>Cap alerta detectada.</strong> Les dades no mostren patrons sospitosos evidents. Aixo no garanteix l\'absencia d\'irregularitats.</p>';
            } else {
                // Separate global alerts from vendor-specific alerts
                const globalAlerts = alerts.filter(a => !a.vendor);
                const vendorAlerts = alerts.filter(a => a.vendor);

                // Group vendor alerts by NIF
                const vendorGroups = {};
                vendorAlerts.forEach(a => {
                    const key = a.vendor.nif || a.vendor.company || 'unknown';
                    if (!vendorGroups[key]) {
                        vendorGroups[key] = {
                            nif: a.vendor.nif,
                            company: a.vendor.company,
                            alerts: [],
                            alertCount: 0,
                            warningCount: 0,
                            infoCount: 0
                        };
                    }
                    vendorGroups[key].alerts.push(a);
                    if (a.type === 'alert') vendorGroups[key].alertCount++;
                    else if (a.type === 'warning') vendorGroups[key].warningCount++;
                    else vendorGroups[key].infoCount++;
                });

                // Sort vendor groups by severity (most alerts first)
                const sortedVendors = Object.values(vendorGroups).sort((a, b) => {
                    const scoreA = a.alertCount * 100 + a.warningCount * 10 + a.infoCount;
                    const scoreB = b.alertCount * 100 + b.warningCount * 10 + b.infoCount;
                    return scoreB - scoreA;
                });

                let html = '';

                // Summary
                html += `<div class="alerts-summary">
                    <div class="summary-item"><strong>${globalAlerts.length}</strong> alertes globals</div>
                    <div class="summary-item"><strong>${sortedVendors.length}</strong> proveidors amb alertes</div>
                    <div class="summary-item"><strong>${vendorAlerts.length}</strong> alertes de proveidor</div>
                </div>`;

                // Global alerts section
                if (globalAlerts.length > 0) {
                    html += '<div class="global-alerts"><h3>Alertes Globals (Sistema)</h3>';
                    html += globalAlerts.map(a => `
                        <div class="alert ${a.type}">
                            <h4>${a.title}</h4>
                            <p>${a.description}</p>
                        </div>
                    `).join('');
                    html += '</div>';
                }

                // Vendor-grouped alerts section
                if (sortedVendors.length > 0) {
                    html += '<div class="vendor-alerts-section"><h3>Alertes per Proveidor (' + sortedVendors.length + ')</h3>';

                    sortedVendors.forEach((group, index) => {
                        const headerClass = group.alertCount > 0 ? 'has-critical' :
                                          group.warningCount > 0 ? 'has-warning' : 'has-info';

                        html += `
                        <div class="vendor-alert-group" id="vendor-group-${index}">
                            <div class="vendor-alert-header ${headerClass}" onclick="document.getElementById('vendor-group-${index}').classList.toggle('expanded')">
                                <div class="vendor-info">
                                    <h4>${group.company || 'Empresa desconeguda'}</h4>
                                    <span class="nif">${group.nif || 'NIF no disponible'}</span>
                                </div>
                                <div class="vendor-badges">
                                    ${group.alertCount > 0 ? `<span class="badge alert-count">${group.alertCount} crit.</span>` : ''}
                                    ${group.warningCount > 0 ? `<span class="badge warning-count">${group.warningCount} avis</span>` : ''}
                                    ${group.infoCount > 0 ? `<span class="badge info-count">${group.infoCount} info</span>` : ''}
                                    <span class="toggle-icon">▼</span>
                                </div>
                            </div>
                            <div class="vendor-alert-details">
                                ${group.alerts.map(a => `
                                    <div class="vendor-alert-item ${a.type}-type">
                                        <strong>${a.title}</strong>
                                        <p>${a.description}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                    });

                    html += '</div>';
                }

                alertsContainer.innerHTML = html;
            }

            // Render top companies
            const topCompaniesContainer = document.getElementById('top-companies');
            topCompaniesContainer.innerHTML = topCompanies.map(([company, count]) => `
                <div class="company-row">
                    <span class="company-name">${company || 'No identificat'}</span>
                    <span class="company-stats">
                        <span><strong>${count}</strong> contractes</span>
                        <span><strong>${formatAmount(companyAmounts[company] || 0)}</strong></span>
                    </span>
                </div>
            `).join('');
        }

        function renderTable() {
            // Sort
            const sorted = [...filteredContracts].sort((a, b) => {
                let aVal = a.normalized[sortColumn];
                let bVal = b.normalized[sortColumn];

                if (sortColumn === 'amount') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Paginate
            const start = (currentPage - 1) * itemsPerPage;
            const pageData = sorted.slice(start, start + itemsPerPage);
            const totalPages = Math.ceil(sorted.length / itemsPerPage);

            // Render
            const tbody = document.getElementById('contracts-body');
            tbody.innerHTML = pageData.map(c => {
                const isNearThreshold = (c.normalized.amount >= THRESHOLDS.minor * 0.9 && c.normalized.amount < THRESHOLDS.minor) ||
                                       (c.normalized.amount >= THRESHOLDS.minorWorks * 0.9 && c.normalized.amount < THRESHOLDS.minorWorks);
                return `
                    <tr class="${isNearThreshold ? 'threshold-highlight' : ''}">
                        <td>${c.normalized.org}</td>
                        <td>${c.normalized.object}</td>
                        <td>${c.normalized.company}</td>
                        <td class="amount">${formatAmount(c.normalized.amount)}</td>
                        <td>${c.normalized.date}</td>
                        <td>${c.normalized.type}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('page-info').textContent = `Pagina ${currentPage} de ${totalPages} (${sorted.length} resultats)`;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderTable();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredContracts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function exportFiltered() {
            const headers = ['Organisme', 'Objecte', 'Adjudicatari', 'Import', 'Data', 'Tipus'];
            const rows = filteredContracts.map(c => [
                c.normalized.org,
                c.normalized.object,
                c.normalized.company,
                c.normalized.amount,
                c.normalized.date,
                c.normalized.type
            ]);

            let csv = headers.join(';') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'contractes_filtrats.csv';
            link.click();
        }
    </script>
</body>
</html>
