<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditoria Contractes Sabadell</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #1a5f7a, #2d8a6e);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        header p {
            opacity: 0.9;
        }

        .data-source {
            background: #e8f4f8;
            border-left: 4px solid #1a5f7a;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
        }

        .data-source a {
            color: #1a5f7a;
            text-decoration: none;
            font-weight: 500;
        }

        .data-source a:hover {
            text-decoration: underline;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .upload-section h2 {
            margin-bottom: 20px;
            color: #1a5f7a;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: #1a5f7a;
            background: #f0f7fa;
        }

        .upload-area.dragover {
            border-color: #2d8a6e;
            background: #e8f5e9;
        }

        #file-input {
            display: none;
        }

        .btn {
            background: #1a5f7a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #134a5f;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #1a5f7a;
        }

        .alerts-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .alerts-section h2 {
            color: #c0392b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert {
            background: #fdf2f2;
            border-left: 4px solid #c0392b;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .alert.warning {
            background: #fef9e7;
            border-left-color: #f39c12;
        }

        .alert.info {
            background: #e8f4f8;
            border-left-color: #3498db;
        }

        .alert h4 {
            margin-bottom: 5px;
        }

        .alert p {
            color: #666;
            font-size: 0.9em;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filters input, .filters select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #1a5f7a;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #1a5f7a;
            color: white;
            padding: 15px;
            text-align: left;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #134a5f;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f7fa;
        }

        .amount {
            font-weight: bold;
            color: #1a5f7a;
        }

        .company-analysis {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .company-analysis h2 {
            margin-bottom: 20px;
            color: #1a5f7a;
        }

        .company-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .company-row:last-child {
            border-bottom: none;
        }

        .company-name {
            font-weight: 500;
        }

        .company-stats {
            display: flex;
            gap: 20px;
            color: #666;
        }

        .highlight {
            background: #fff3cd;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .hidden {
            display: none;
        }

        .threshold-highlight {
            background: #ffeaa7;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }

        footer a {
            color: #1a5f7a;
        }

        .instructions {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .instructions h2 {
            color: #1a5f7a;
            margin-bottom: 15px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        .instructions code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .debug-panel {
            background: #2d2d2d;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .debug-panel h3 {
            color: #4fc3f7;
            margin-bottom: 15px;
        }

        .debug-panel .mapping {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .debug-panel .field-name {
            color: #81c784;
            min-width: 100px;
        }

        .debug-panel .column-name {
            color: #fff59d;
        }

        .debug-panel .not-found {
            color: #ef5350;
        }

        .debug-panel details {
            margin-top: 15px;
        }

        .debug-panel summary {
            cursor: pointer;
            color: #4fc3f7;
        }

        .debug-panel .all-headers {
            margin-top: 10px;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Auditoria de Contractes Publics - Sabadell</h1>
            <p>Eina per analitzar els contractes publics de l'Ajuntament de Sabadell i detectar possibles irregularitats</p>
        </header>

        <div class="data-source">
            <strong>Font de dades:</strong> Les dades provenen del
            <a href="https://dadesobertes.seu-e.cat/dataset/css-rc-contractes-pscp" target="_blank">Portal de Dades Obertes del Consorci AOC</a>
            i del <a href="https://contractacio.ajsabadell.cat/" target="_blank">Portal de Licitacio de l'Ajuntament de Sabadell</a>.
        </div>

        <div class="instructions">
            <h2>Com utilitzar aquesta eina</h2>
            <ol>
                <li><strong>Descarrega les dades:</strong> Ves a <a href="https://dadesobertes.seu-e.cat/csv/css-rc-contractes-pscp-socrata.csv" target="_blank">aquest enllac</a> per descarregar el fitxer CSV amb tots els contractes (pot trigar una mica, es un fitxer gran).</li>
                <li><strong>Carrega el fitxer:</strong> Arrossega el fitxer CSV a l'area de sota o fes clic per seleccionar-lo.</li>
                <li><strong>Filtra per Sabadell:</strong> Un cop carregat, utilitza el filtre "Organisme" per seleccionar "Ajuntament de Sabadell" o altres ens municipals.</li>
                <li><strong>Analitza les alertes:</strong> Revisa la seccio d'alertes per veure possibles irregularitats detectades automaticament.</li>
            </ol>
        </div>

        <div class="upload-section" id="upload-section">
            <h2>Carrega el fitxer de contractes</h2>
            <div class="upload-area" id="upload-area">
                <p>Arrossega el fitxer CSV aqui o fes clic per seleccionar-lo</p>
                <input type="file" id="file-input" accept=".csv">
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 0.9em;">Format acceptat: CSV</p>
        </div>

        <div id="results" class="hidden">
            <div class="debug-panel" id="debug-panel">
                <h3>Columnes detectades del CSV</h3>
                <div id="column-mappings"></div>
                <details>
                    <summary>Veure totes les columnes del CSV</summary>
                    <div class="all-headers" id="all-headers"></div>
                </details>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Contractes</h3>
                    <div class="value" id="total-contracts">0</div>
                </div>
                <div class="stat-card">
                    <h3>Import Total</h3>
                    <div class="value" id="total-amount">0 EUR</div>
                </div>
                <div class="stat-card">
                    <h3>Empreses Diferents</h3>
                    <div class="value" id="unique-companies">0</div>
                </div>
                <div class="stat-card">
                    <h3>Alertes Detectades</h3>
                    <div class="value" id="alerts-count">0</div>
                </div>
            </div>

            <div class="alerts-section" id="alerts-section">
                <h2>Alertes i Indicadors de Risc</h2>
                <div id="alerts-container">
                    <p class="loading">Analitzant dades...</p>
                </div>
            </div>

            <div class="company-analysis">
                <h2>Empreses amb mes contractes</h2>
                <div id="top-companies"></div>
            </div>

            <div class="filters">
                <input type="text" id="search" placeholder="Cercar per text...">
                <select id="filter-org">
                    <option value="">Tots els organismes</option>
                </select>
                <select id="filter-type">
                    <option value="">Tots els tipus</option>
                </select>
                <select id="filter-year">
                    <option value="">Tots els anys</option>
                </select>
                <button class="btn btn-secondary" onclick="resetFilters()">Netejar filtres</button>
                <button class="btn" onclick="exportFiltered()">Exportar filtrat (CSV)</button>
            </div>

            <div class="table-container">
                <table id="contracts-table">
                    <thead>
                        <tr>
                            <th onclick="sortTable('org')">Organisme</th>
                            <th onclick="sortTable('object')">Objecte</th>
                            <th onclick="sortTable('company')">Adjudicatari</th>
                            <th onclick="sortTable('amount')">Import</th>
                            <th onclick="sortTable('date')">Data</th>
                            <th onclick="sortTable('type')">Tipus</th>
                        </tr>
                    </thead>
                    <tbody id="contracts-body">
                    </tbody>
                </table>
            </div>

            <div id="pagination" style="text-align: center; margin: 20px 0;">
                <button class="btn btn-secondary" onclick="prevPage()">Anterior</button>
                <span id="page-info" style="margin: 0 20px;"></span>
                <button class="btn btn-secondary" onclick="nextPage()">Seguent</button>
            </div>
        </div>

        <footer>
            <p>Eina creada per promoure la transparencia i la participacio ciutadana.</p>
            <p>Dades obertes de <a href="https://dadesobertes.seu-e.cat/" target="_blank">Consorci AOC</a> |
               <a href="https://web.sabadell.cat/transparencia" target="_blank">Portal de Transparencia de Sabadell</a></p>
        </footer>
    </div>

    <script>
        let allContracts = [];
        let filteredContracts = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let sortColumn = 'date';
        let sortDirection = 'desc';
        let csvHeaders = []; // Store headers for debugging

        // Thresholds for contract types (simplified - actual thresholds vary)
        const THRESHOLDS = {
            minor: 15000,      // Contractes menors serveis/subministraments
            minorWorks: 40000, // Contractes menors obres
            negotiated: 60000  // Procediment negociat
        };

        // Column mappings - ordered by priority (most specific first)
        // Based on actual CSV from Consorci AOC: denominacio_adjudicatari is company name,
        // identificacio_adjudicatari is NIF, data_adjudicacio_contracte is date
        const COLUMN_MAPPINGS = {
            org: [
                'nom_organ', 'nom_ens', 'nom ens', 'ens', 'organ_contractacio',
                'organisme', 'entitat', 'administracio'
            ],
            object: [
                'objecte_contracte', 'objecte contracte', 'objecte', 'descripcio_contracte',
                'descripcio', 'titol', 'nom_contracte'
            ],
            company: [
                'denominacio_adjudicatari',  // This is the actual company name in Consorci AOC data
                'rao_social_adjudicatari', 'rao social adjudicatari', 'nom_adjudicatari',
                'nom adjudicatari', 'adjudicatari_rao_social', 'empresa_adjudicataria',
                'nom_empresa', 'rao_social'
            ],
            nif: [
                'identificacio_adjudicatari',  // This is the actual NIF in Consorci AOC data
                'nif_adjudicatari', 'nif adjudicatari', 'cif_adjudicatari',
                'identificador_adjudicatari'
            ],
            amount: [
                'import_adjudicacio_sense_iva', 'import_adjudicacio_amb_iva',
                'import_adjudicacio', 'import adjudicacio', 'import_licitacio',
                'preu_adjudicacio', 'valor_estimat', 'import', 'preu', 'valor'
            ],
            date: [
                'data_adjudicacio_contracte',  // This is the actual date in Consorci AOC data
                'data_adjudicacio', 'data adjudicacio', 'data_formalitzacio',
                'data_formalitzacio_contracte', 'data_publicacio', 'data_inici', 'data'
            ],
            type: [
                'tipus_contracte', 'tipus contracte', 'tipus'
            ],
            // New fields for advanced detection
            procedure: [
                'procediment_adjudicacio', 'procediment', 'tipus_procediment'
            ],
            cpv: [
                'codi_cpv', 'cpv', 'codi_cpv_principal'
            ],
            budget: [
                'pressupost_licitacio_sense_iva', 'pressupost_licitacio',
                'valor_estimat_contracte', 'valor_estimat'
            ],
            bidsReceived: [
                'ofertes_rebudes', 'nombre_ofertes', 'num_ofertes', 'licitadors'
            ],
            publicationDate: [
                'data_publicacio_anunci', 'data_publicacio', 'data_anunci'
            ],
            offerDeadline: [
                'termini_presentacio_ofertes', 'data_limit_presentacio',
                'data_fi_presentacio', 'termini_ofertes'
            ],
            department: [
                'nom_departament_ens', 'departament', 'unitat_tramitadora',
                'area', 'servei'
            ],
            expedient: [
                'codi_expedient', 'numero_expedient', 'expedient', 'referencia'
            ]
        };

        // Upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);
            csvHeaders = headers.map(h => h.trim().toLowerCase());

            // Log headers to console for debugging
            console.log('CSV Headers found:', csvHeaders);

            allContracts = [];

            // Create header index map for faster lookup
            const headerIndex = {};
            csvHeaders.forEach((header, index) => {
                headerIndex[header] = index;
            });

            // Find the best matching column for each field type
            const columnMap = {};
            for (const [fieldType, possibleNames] of Object.entries(COLUMN_MAPPINGS)) {
                columnMap[fieldType] = findBestColumn(csvHeaders, possibleNames);
                console.log(`Mapping ${fieldType} -> ${columnMap[fieldType]}`);
            }

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = parseCSVLine(lines[i]);

                // Create contract object with normalized fields
                const contract = {
                    raw: {},
                    normalized: {}
                };

                // Store raw values
                csvHeaders.forEach((header, index) => {
                    contract.raw[header] = values[index] || '';
                });

                // Map to normalized fields using our column mapping
                contract.normalized = {
                    org: columnMap.org ? (contract.raw[columnMap.org] || '') : '',
                    object: columnMap.object ? (contract.raw[columnMap.object] || '') : '',
                    company: columnMap.company ? (contract.raw[columnMap.company] || '') : '',
                    nif: columnMap.nif ? (contract.raw[columnMap.nif] || '') : '',
                    amount: parseAmount(columnMap.amount ? (contract.raw[columnMap.amount] || '') : ''),
                    date: columnMap.date ? (contract.raw[columnMap.date] || '') : '',
                    type: columnMap.type ? (contract.raw[columnMap.type] || '') : '',
                    // New fields for advanced detection
                    procedure: columnMap.procedure ? (contract.raw[columnMap.procedure] || '') : '',
                    cpv: columnMap.cpv ? (contract.raw[columnMap.cpv] || '') : '',
                    budget: parseAmount(columnMap.budget ? (contract.raw[columnMap.budget] || '') : ''),
                    bidsReceived: parseInt(columnMap.bidsReceived ? (contract.raw[columnMap.bidsReceived] || '') : '') || 0,
                    publicationDate: columnMap.publicationDate ? (contract.raw[columnMap.publicationDate] || '') : '',
                    offerDeadline: columnMap.offerDeadline ? (contract.raw[columnMap.offerDeadline] || '') : '',
                    department: columnMap.department ? (contract.raw[columnMap.department] || '') : '',
                    expedient: columnMap.expedient ? (contract.raw[columnMap.expedient] || '') : ''
                };

                allContracts.push(contract);
            }

            console.log('Total contracts loaded:', allContracts.length);
            console.log('Sample contract:', allContracts[0]);

            // Update debug panel
            updateDebugPanel(columnMap);

            // Filter for Sabadell if possible
            const sabadellContracts = allContracts.filter(c =>
                c.normalized.org.toLowerCase().includes('sabadell')
            );

            console.log('Sabadell contracts found:', sabadellContracts.length);

            if (sabadellContracts.length > 0) {
                filteredContracts = sabadellContracts;
            } else {
                filteredContracts = allContracts;
            }

            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');

            populateFilters();
            analyzeData();
            renderTable();
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if ((char === ',' || char === ';') && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());

            return result;
        }

        function findBestColumn(headers, possibleNames) {
            // First pass: exact match
            for (const name of possibleNames) {
                const exactMatch = headers.find(h => h === name);
                if (exactMatch) return exactMatch;
            }

            // Second pass: contains match (but be careful with order)
            for (const name of possibleNames) {
                const containsMatch = headers.find(h => h.includes(name) && !isExcludedMatch(h, name));
                if (containsMatch) return containsMatch;
            }

            return null;
        }

        // Avoid matching NIF fields when looking for company names, etc.
        function isExcludedMatch(header, searchTerm) {
            // If searching for 'adjudicatari' but header is 'nif_adjudicatari', skip it
            if (searchTerm === 'adjudicatari' && header.includes('nif')) return true;
            if (searchTerm === 'adjudicatari' && header.includes('cif')) return true;
            return false;
        }

        // Check if a string looks like a valid company name
        function isInvalidCompanyName(name) {
            if (!name) return true;
            const upper = name.toUpperCase().trim();
            // Invalid patterns: looks like NIF, too short, only numbers, only punctuation
            if (upper === 'NIF' || upper === 'CIF') return true;
            if (/^[A-Z]?\d{7,8}[A-Z]?$/.test(upper)) return true; // NIF pattern
            if (/^\d+$/.test(upper)) return true; // Only numbers
            if (/^[^a-zA-Z]+$/.test(upper)) return true; // No letters
            if (upper.includes('NIF||')) return true; // Corrupted data pattern
            if (upper.split('||').length > 2) return true; // Multiple delimiters
            return false;
        }

        function updateDebugPanel(columnMap) {
            const fieldLabels = {
                org: 'Organisme',
                object: 'Objecte',
                company: 'Adjudicatari',
                nif: 'NIF',
                amount: 'Import',
                date: 'Data',
                type: 'Tipus',
                procedure: 'Procediment',
                cpv: 'CPV',
                budget: 'Pressupost',
                bidsReceived: 'Ofertes rebudes',
                publicationDate: 'Data publicacio',
                offerDeadline: 'Termini ofertes',
                department: 'Departament',
                expedient: 'Expedient'
            };

            const mappingsHtml = Object.entries(columnMap).map(([field, column]) => `
                <div class="mapping">
                    <span class="field-name">${fieldLabels[field]}:</span>
                    ${column
                        ? `<span class="column-name">"${column}"</span>`
                        : `<span class="not-found">NO TROBAT</span>`
                    }
                </div>
            `).join('');

            document.getElementById('column-mappings').innerHTML = mappingsHtml;
            document.getElementById('all-headers').innerHTML = csvHeaders.map(h => `"${h}"`).join(', ');
        }

        function parseAmount(value) {
            if (!value) return 0;
            // Remove currency symbols, spaces, and handle European number format
            const cleaned = value.toString()
                .replace(/[^0-9,.\-]/g, '')
                .replace(/\.(?=.*,)/g, '')  // Remove thousand separators
                .replace(',', '.');          // Convert decimal comma to point
            return parseFloat(cleaned) || 0;
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('ca-ES', {
                style: 'currency',
                currency: 'EUR'
            }).format(amount);
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Handle various date formats: YYYY-MM-DD, DD/MM/YYYY, DD-MM-YYYY
            let match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (match) {
                return new Date(match[1], match[2] - 1, match[3]);
            }
            match = dateStr.match(/(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
            if (match) {
                return new Date(match[3], match[2] - 1, match[1]);
            }
            // Try native parsing as fallback
            const parsed = new Date(dateStr);
            return isNaN(parsed.getTime()) ? null : parsed;
        }

        function populateFilters() {
            const orgs = [...new Set(allContracts.map(c => c.normalized.org).filter(Boolean))].sort();
            const types = [...new Set(allContracts.map(c => c.normalized.type).filter(Boolean))].sort();
            const years = [...new Set(allContracts.map(c => {
                const date = c.normalized.date;
                const match = date.match(/\d{4}/);
                return match ? match[0] : null;
            }).filter(Boolean))].sort().reverse();

            const orgSelect = document.getElementById('filter-org');
            orgs.forEach(org => {
                const option = document.createElement('option');
                option.value = org;
                option.textContent = org.length > 50 ? org.substring(0, 50) + '...' : org;
                orgSelect.appendChild(option);
            });

            const typeSelect = document.getElementById('filter-type');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            const yearSelect = document.getElementById('filter-year');
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            // Add filter event listeners
            document.getElementById('search').addEventListener('input', applyFilters);
            document.getElementById('filter-org').addEventListener('change', applyFilters);
            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('filter-year').addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const org = document.getElementById('filter-org').value;
            const type = document.getElementById('filter-type').value;
            const year = document.getElementById('filter-year').value;

            filteredContracts = allContracts.filter(c => {
                const matchSearch = !search ||
                    c.normalized.object.toLowerCase().includes(search) ||
                    c.normalized.company.toLowerCase().includes(search) ||
                    c.normalized.org.toLowerCase().includes(search);

                const matchOrg = !org || c.normalized.org === org;
                const matchType = !type || c.normalized.type === type;
                const matchYear = !year || c.normalized.date.includes(year);

                return matchSearch && matchOrg && matchType && matchYear;
            });

            currentPage = 1;
            analyzeData();
            renderTable();
        }

        function resetFilters() {
            document.getElementById('search').value = '';
            document.getElementById('filter-org').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-year').value = '';
            filteredContracts = allContracts;
            currentPage = 1;
            analyzeData();
            renderTable();
        }

        function analyzeData() {
            // Basic stats
            const totalContracts = filteredContracts.length;
            const totalAmount = filteredContracts.reduce((sum, c) => sum + c.normalized.amount, 0);
            const uniqueCompanies = new Set(filteredContracts.map(c => c.normalized.company).filter(Boolean)).size;

            document.getElementById('total-contracts').textContent = totalContracts.toLocaleString('ca-ES');
            document.getElementById('total-amount').textContent = formatAmount(totalAmount);
            document.getElementById('unique-companies').textContent = uniqueCompanies.toLocaleString('ca-ES');

            // Analyze for potential issues
            const alerts = [];

            // 1. Companies with many contracts
            const companyContracts = {};
            const companyAmounts = {};
            filteredContracts.forEach(c => {
                const company = c.normalized.company;
                // Skip invalid company names (too short, looks like a NIF, or contains only special chars)
                if (company && company.length > 5 && !isInvalidCompanyName(company)) {
                    companyContracts[company] = (companyContracts[company] || 0) + 1;
                    companyAmounts[company] = (companyAmounts[company] || 0) + c.normalized.amount;
                }
            });

            const topCompanies = Object.entries(companyContracts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            // Alert for companies with disproportionate contracts
            topCompanies.forEach(([company, count]) => {
                const percentage = (count / totalContracts * 100).toFixed(1);
                if (percentage > 5 && count > 10) {
                    alerts.push({
                        type: 'warning',
                        title: `Concentracio de contractes: ${company}`,
                        description: `Aquesta empresa te ${count} contractes (${percentage}% del total), amb un import total de ${formatAmount(companyAmounts[company])}.`
                    });
                }
            });

            // ============================================================
            // DETECTION INDICATORS (based on anti-corruption best practices)
            // ============================================================

            // Helper: extract fiscal year from date
            function getFiscalYear(dateStr) {
                const match = dateStr.match(/\d{4}/);
                return match ? match[0] : null;
            }

            // Helper: extract CPV prefix (first 2-4 digits = sector)
            function getCpvSector(cpv) {
                if (!cpv) return null;
                const match = cpv.toString().match(/^(\d{2,4})/);
                return match ? match[1] : null;
            }

            // ----------------------------------------------------------
            // 1. CONTRACT SPLITTING (Fraccionament de Contractes)
            // Group by: NIF + CPV sector + Fiscal Year
            // Flag if combined value exceeds threshold
            // ----------------------------------------------------------
            const splittingGroups = {};
            filteredContracts.forEach(c => {
                const nif = c.normalized.nif;
                const cpvSector = getCpvSector(c.normalized.cpv) || 'unknown';
                const year = getFiscalYear(c.normalized.date) || 'unknown';

                if (nif && c.normalized.amount > 0 && c.normalized.amount < THRESHOLDS.minorWorks) {
                    const key = `${nif}|||${cpvSector}|||${year}`;
                    if (!splittingGroups[key]) {
                        splittingGroups[key] = {
                            nif: nif,
                            company: c.normalized.company,
                            cpvSector: cpvSector,
                            year: year,
                            contracts: [],
                            totalAmount: 0
                        };
                    }
                    splittingGroups[key].contracts.push(c);
                    splittingGroups[key].totalAmount += c.normalized.amount;
                }
            });

            Object.values(splittingGroups).forEach(group => {
                if (group.contracts.length < 2) return;

                const allUnderMinor = group.contracts.every(c => c.normalized.amount < THRESHOLDS.minor);
                const allUnderWorks = group.contracts.every(c => c.normalized.amount < THRESHOLDS.minorWorks);

                // Flag if all contracts under threshold but combined exceeds it
                if (allUnderMinor && group.totalAmount >= THRESHOLDS.minor) {
                    alerts.push({
                        type: 'alert',
                        title: `Possible fraccionament: ${group.company || group.nif}`,
                        description: `${group.contracts.length} contractes menors al mateix proveidor (NIF: ${group.nif}) en el sector CPV ${group.cpvSector} durant ${group.year}, amb un total de ${formatAmount(group.totalAmount)} (supera el llindar de 15.000€).`
                    });
                } else if (allUnderWorks && group.totalAmount >= THRESHOLDS.minorWorks) {
                    alerts.push({
                        type: 'alert',
                        title: `Possible fraccionament (obres): ${group.company || group.nif}`,
                        description: `${group.contracts.length} contractes menors al mateix proveidor (NIF: ${group.nif}) en el sector CPV ${group.cpvSector} durant ${group.year}, amb un total de ${formatAmount(group.totalAmount)} (supera el llindar de 40.000€).`
                    });
                }
            });

            // ----------------------------------------------------------
            // 2. STRATEGIC THRESHOLD (Llindar Estrategic)
            // Flag contracts in suspicious ranges: €14,900-€14,999 or €39,900-€39,999
            // ----------------------------------------------------------
            const strategicThreshold = filteredContracts.filter(c => {
                const amount = c.normalized.amount;
                return (amount >= 14900 && amount <= 14999) ||
                       (amount >= 39900 && amount <= 39999);
            });

            if (strategicThreshold.length > 0) {
                alerts.push({
                    type: 'alert',
                    title: `${strategicThreshold.length} contractes amb import "estrategic"`,
                    description: `Contractes amb imports entre €14.900-€14.999 o €39.900-€39.999, just per sota dels llindars legals. Risc ALT: podria indicar manipulacio del pressupost per evitar supervisio.`
                });
            }

            // ----------------------------------------------------------
            // 3. SINGLE BIDDER (Absencia de Competencia)
            // Open procedures with only 1 bid received
            // ----------------------------------------------------------
            const singleBidder = filteredContracts.filter(c => {
                const isOpen = c.normalized.procedure.toLowerCase().includes('obert');
                return isOpen && c.normalized.bidsReceived === 1;
            });

            if (singleBidder.length > 5) {
                alerts.push({
                    type: 'warning',
                    title: `${singleBidder.length} procediments oberts amb un sol licitador`,
                    description: `Procediments oberts on nomes es va presentar una oferta. Pot indicar que el plec estava fet a mida o que altres empreses van ser descoratjades a participar.`
                });
            }

            // ----------------------------------------------------------
            // 4. ZERO DISCOUNT (Possible Col·lusio)
            // Award amount equals budget exactly (in open procedures)
            // ----------------------------------------------------------
            const zeroDiscount = filteredContracts.filter(c => {
                const isOpen = c.normalized.procedure.toLowerCase().includes('obert');
                const hasBudget = c.normalized.budget > 0;
                const hasAmount = c.normalized.amount > 0;
                if (!isOpen || !hasBudget || !hasAmount) return false;

                const difference = Math.abs(c.normalized.budget - c.normalized.amount);
                const percentDiff = (difference / c.normalized.budget) * 100;
                return percentDiff < 0.1; // Less than 0.1% difference
            });

            if (zeroDiscount.length > 3) {
                alerts.push({
                    type: 'warning',
                    title: `${zeroDiscount.length} adjudicacions sense descompte`,
                    description: `Procediments oberts on l'import adjudicat es exactament igual al pressupost de licitacio (0% descompte). En un mercat competitiu, normalment hi ha alguna rebaixa.`
                });
            }

            // ----------------------------------------------------------
            // 5. SPEED BIDDING (Terminis Sospitosament Curts)
            // Short time between publication and deadline
            // ----------------------------------------------------------
            const speedBidding = filteredContracts.filter(c => {
                if (!c.normalized.publicationDate || !c.normalized.offerDeadline) return false;

                const pubDate = parseDate(c.normalized.publicationDate);
                const deadline = parseDate(c.normalized.offerDeadline);
                if (!pubDate || !deadline) return false;

                const daysDiff = (deadline - pubDate) / (1000 * 60 * 60 * 24);
                const estimatedValue = c.normalized.budget || c.normalized.amount;

                // High value (>200k) with <15 days, or lower value with <5 days
                if (estimatedValue > 200000 && daysDiff < 15 && daysDiff > 0) return true;
                if (estimatedValue <= 200000 && daysDiff < 5 && daysDiff > 0) return true;
                return false;
            });

            if (speedBidding.length > 0) {
                alerts.push({
                    type: 'alert',
                    title: `${speedBidding.length} licitacions amb termini molt curt`,
                    description: `Procediments amb un termini de presentacio d'ofertes sospitosament curt. Nomes algú amb informacio privilegiada podria preparar una oferta valida.`
                });
            }

            // ----------------------------------------------------------
            // 6. DEPARTMENT CONCENTRATION (Concentracio per Departament)
            // Single vendor receives >50% of a department's budget in one year
            // ----------------------------------------------------------
            const deptBudgets = {};
            const deptVendorAmounts = {};

            filteredContracts.forEach(c => {
                const dept = c.normalized.department || c.normalized.org;
                const nif = c.normalized.nif;
                const year = getFiscalYear(c.normalized.date) || 'unknown';

                if (dept && nif && c.normalized.amount > 0) {
                    const deptKey = `${dept}|||${year}`;
                    const vendorKey = `${dept}|||${nif}|||${year}`;

                    deptBudgets[deptKey] = (deptBudgets[deptKey] || 0) + c.normalized.amount;

                    if (!deptVendorAmounts[vendorKey]) {
                        deptVendorAmounts[vendorKey] = {
                            dept: dept,
                            nif: nif,
                            company: c.normalized.company,
                            year: year,
                            amount: 0
                        };
                    }
                    deptVendorAmounts[vendorKey].amount += c.normalized.amount;
                }
            });

            Object.values(deptVendorAmounts).forEach(v => {
                const deptKey = `${v.dept}|||${v.year}`;
                const deptTotal = deptBudgets[deptKey] || 0;

                if (deptTotal > 50000 && v.amount > deptTotal * 0.5) {
                    const percentage = ((v.amount / deptTotal) * 100).toFixed(1);
                    alerts.push({
                        type: 'warning',
                        title: `Concentracio: ${v.company || v.nif} al ${v.dept.substring(0, 40)}...`,
                        description: `Aquest proveidor rep el ${percentage}% del pressupost del departament durant ${v.year} (${formatAmount(v.amount)} de ${formatAmount(deptTotal)}).`
                    });
                }
            });

            // ----------------------------------------------------------
            // 7. MISSING IDENTIFICATION (Original indicator - kept)
            // ----------------------------------------------------------
            const noNIF = filteredContracts.filter(c => !c.normalized.nif && c.normalized.amount > 5000);
            if (noNIF.length > 10) {
                alerts.push({
                    type: 'info',
                    title: `${noNIF.length} contractes sense NIF/CIF`,
                    description: `Alguns contractes de mes de 5.000€ no tenen identificacio fiscal de l'empresa adjudicataria.`
                });
            }

            // Render alerts
            const alertsContainer = document.getElementById('alerts-container');
            document.getElementById('alerts-count').textContent = alerts.length;

            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<p class="alert info"><strong>Cap alerta detectada.</strong> Les dades no mostren patrons sospitosos evidents. Aixo no garanteix l\'absencia d\'irregularitats.</p>';
            } else {
                alertsContainer.innerHTML = alerts.map(a => `
                    <div class="alert ${a.type}">
                        <h4>${a.title}</h4>
                        <p>${a.description}</p>
                    </div>
                `).join('');
            }

            // Render top companies
            const topCompaniesContainer = document.getElementById('top-companies');
            topCompaniesContainer.innerHTML = topCompanies.map(([company, count]) => `
                <div class="company-row">
                    <span class="company-name">${company || 'No identificat'}</span>
                    <span class="company-stats">
                        <span><strong>${count}</strong> contractes</span>
                        <span><strong>${formatAmount(companyAmounts[company] || 0)}</strong></span>
                    </span>
                </div>
            `).join('');
        }

        function renderTable() {
            // Sort
            const sorted = [...filteredContracts].sort((a, b) => {
                let aVal = a.normalized[sortColumn];
                let bVal = b.normalized[sortColumn];

                if (sortColumn === 'amount') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else {
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            // Paginate
            const start = (currentPage - 1) * itemsPerPage;
            const pageData = sorted.slice(start, start + itemsPerPage);
            const totalPages = Math.ceil(sorted.length / itemsPerPage);

            // Render
            const tbody = document.getElementById('contracts-body');
            tbody.innerHTML = pageData.map(c => {
                const isNearThreshold = (c.normalized.amount >= THRESHOLDS.minor * 0.9 && c.normalized.amount < THRESHOLDS.minor) ||
                                       (c.normalized.amount >= THRESHOLDS.minorWorks * 0.9 && c.normalized.amount < THRESHOLDS.minorWorks);
                return `
                    <tr class="${isNearThreshold ? 'threshold-highlight' : ''}">
                        <td>${c.normalized.org}</td>
                        <td>${c.normalized.object}</td>
                        <td>${c.normalized.company}</td>
                        <td class="amount">${formatAmount(c.normalized.amount)}</td>
                        <td>${c.normalized.date}</td>
                        <td>${c.normalized.type}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('page-info').textContent = `Pagina ${currentPage} de ${totalPages} (${sorted.length} resultats)`;
        }

        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            renderTable();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredContracts.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function exportFiltered() {
            const headers = ['Organisme', 'Objecte', 'Adjudicatari', 'Import', 'Data', 'Tipus'];
            const rows = filteredContracts.map(c => [
                c.normalized.org,
                c.normalized.object,
                c.normalized.company,
                c.normalized.amount,
                c.normalized.date,
                c.normalized.type
            ]);

            let csv = headers.join(';') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'contractes_filtrats.csv';
            link.click();
        }
    </script>
</body>
</html>
